<!doctype html>
<!-- Head -->
<html lang="en" dir="ltr">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test Your Knowledge — Quiz</title>
  <meta name="description" content="Test your knowledge with a random set of Arabic questions">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">
 </head>
 <!-- Body -->
 <body>
  <!-- Header -->
  <header class="site-header">
   <!-- Navigation -->
   <nav class="navbar" aria-label="Main navigation">
    <!-- Nav list -->
    <ul id="nav-links" class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li class="dropdown">
        <a class="dropbtn">Regions</a>
        <!-- Regions dropdown list -->
        <ul class="dropdown-content">
          <li><a href="North.html">Northern Region</a></li>
          <li><a href="South.html">Southern Region</a></li>
          <li><a href="West.html">Western Region</a></li>
          <li><a href="East.html">Eastern Region</a></li>
          <li><a href="Central.html">Central Region</a></li>
        </ul>
      </li>
      <li><a href="QUIZ.html">Quizzes</a></li>
      <li><a href="sign/SignUp_LogIn_Form.html">Login</a></li>
    </ul>
    <a class="brand" href="index.html" aria-label="Home">Saudi Culture</a>
    <button class="menu-toggle" aria-expanded="false" aria-controls="nav-links" aria-label="Open/close menu">☰</button>
   </nav>
  </header>

  <!-- Main -->
  <main id="main">
   <!-- Quiz intro -->
   <section class="section section-intro">
    <div class="container">

    <h2>Test your knowledge</h2>
    <p>Choose the number of questions then start the quiz. Results will be shown after completion.</p>

     <div class="two-col" style="margin-top:1rem">
      <!-- Settings Panel -->
      <div>
       <!-- Number of questions -->
       <label>Select number of questions:</label>
       <select id="questionCount">
         <option value="5">5 questions</option>
         <option value="10">10 questions</option>
         <option value="15">15 questions</option>
         <option value="20">20 questions</option>
       </select>

       <!-- Region filter: mapped to CSV filenames (see data/) -->
       <label>Select region/source:</label>
       <select id="regionFilter">
         <option value="Words">Built-in (fallback)</option>
         <option value="GENERAL">GENERAL (English)</option>
         <option value="CENTERAL">Central</option>
         <option value="NORTH">NORTH (English)</option>
         <option value="SOUTH">SOUTH (English)</option>
         <option value="EAST">EAST (English)</option>
         <option value="WEST">WEST (English)</option>
         <option value="Words">Words (Arabic)</option>
         <option value="Phrases">Phrases (Arabic)</option>
         <option value="Proverbs">Proverbs (Arabic)</option>
         <option value="RANDOM">Random Region</option>
       </select>

       <!-- Question Type -->
       <label style="margin-top:12px;display:block">Select question type:</label>
       <select id="typeFilter">
         <option value="all">All Types</option>
         <option value="randomType">Random from All Types</option>
         <option value="mcq">Multiple Choice</option>
         <option value="tf">True/False</option>
         <option value="fill">Fill in the Blank</option>
         <option value="multi">Multiple Answers (Choose more than one)</option>
       </select>

       <!-- Category Filter -->
       <label style="margin-top:12px;display:block">Select category:</label>
       <select id="categoryFilter">
         <option value="all">All Categories</option>
         <option value="food">Food</option>
         <option value="clothes">Clothes</option>
         <option value="celebration">Celebration</option>
         <option value="games">Entertainment</option>
         <option value="games">Crafts and Work</option>
         <option value="games">Dating</option>
         <option value="games">Languages and Communication</option>
       </select>

       <!-- Language -->
       <label style="margin-top:12px;display:block">Select language:</label>
       <select id="langSelect">
         <option value="ar">Arabic</option>
         <option value="en">English</option>
       </select>

       <!-- Start Quiz Button -->
       <div style="margin-top:12px">
         <a class="btn btn-primary" id="startBtn" href="#quiz">Start Quiz</a>
       </div>
      </div>

      <!-- Informational Text -->
      <div>
      <p>This quiz displays questions in Arabic from a general question bank. Questions are chosen randomly and presented as multiple-choice options.</p>
      </div>
     </div>
    </div>
   </section>

  <!-- Quiz Section -->
  <section id="quiz" class="section section-alt">
    <div class="container">
     <div id="quizContainer"></div>
     <div id="result" style="margin-top:1rem;font-weight:700"></div>
    </div>
   </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer" aria-label="footer">
   <div class="container footer-grid">
    <ul class="footer-links">
     <li><a href="#top">Back to Top</a></li>
     <li><a href="#main">Questions</a></li>
    </ul>
    <div style="text-align:right">
     <strong>Saudi Culture</strong>
     <p>© 2025 All rights reserved</p>
    </div>
   </div>
  </footer>
  <!-- Scripts -->
  <script src="assets/script.js"></script>
  <script src="assets/quiz-parser.js"></script>

  <!-- Quiz Script -->
  <script>
  /*
    Array of quiz questions.
    Each question object contains:
    - question: The question text
    - choices: Multiple-choice answers
    - answer: The correct answer
  */
  
  /*
    Function to shuffle array elements
    (Used to randomize question order and choice order)
  */
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // Array to store randomly selected questions
  let selectedQuestions = [];

  async function startQuiz(){
    const count = Number(document.getElementById('questionCount').value) || 5;
    const regionSelect = document.getElementById('regionFilter');
    const regionValue = regionSelect ? regionSelect.value : 'Words';

    // helper list of known region CSVs (matches files under data/)
    const regionFiles = ['GENERAL','CENTERAL','NORTH','SOUTH','EAST','WEST'];

    // determine source to request from server
    let source = 'Words';
    if (regionValue === 'RANDOM') {
      source = regionFiles[Math.floor(Math.random()*regionFiles.length)];
    } else if (regionValue && regionValue !== 'Words') {
      source = regionValue;
    }

    const resultEl = document.getElementById('result');
    resultEl.innerHTML = 'Loading quiz...';
    const lang = document.getElementById('langSelect') ? document.getElementById('langSelect').value : 'ar';

    // read UI filters
    const type = document.getElementById('typeFilter') ? document.getElementById('typeFilter').value : 'all';
    const category = document.getElementById('categoryFilter') ? document.getElementById('categoryFilter').value : 'all';

    // try client-side CSV loader first (works without PHP)
    if (typeof fetchQuestions === 'function'){
      try{
        const clientQ = await fetchQuestions(source, count, lang, type, category);
        if(Array.isArray(clientQ) && clientQ.length>0){
          selectedQuestions = clientQ.map(q => ({
            question: q.question,
            choices: Array.isArray(q.choices) ? q.choices.slice() : [],
            answer: q.answer || null
          }));
          selectedQuestions.forEach(q => shuffle(q.choices));
          displayQuestions();
          resultEl.innerHTML = '';
          window.location.hash = '#quiz';
          return;
        } else {
          resultEl.innerHTML = 'No questions returned from client parser, trying server...';
        }
      }catch(e){
        console.warn('client-side parser failed:', e);
      }
    }

    // try server-side endpoint first with a timeout
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 6000); // 6s timeout

    try {
      const qs = new URLSearchParams({ source: source, count: String(count), type: type || '', category: category || '' });
      const resp = await fetch(`quiz.php?${qs.toString()}`, { signal: controller.signal });
      clearTimeout(timeout);
      if (resp.ok) {
        const data = await resp.json();
        if (data && Array.isArray(data.questions) && data.questions.length > 0) {
          selectedQuestions = data.questions.map(q => ({
            question: q.question,
            choices: Array.isArray(q.choices) ? q.choices.slice() : [],
            answer: q.answer || null
          }));
          // shuffle choices for each question
          selectedQuestions.forEach(q => shuffle(q.choices));
          displayQuestions();
          resultEl.innerHTML = '';
          window.location.hash = '#quiz';
          return;
        } else {
          resultEl.innerHTML = 'No questions returned from server, using local fallback.';
        }
      } else {
        resultEl.innerHTML = `Server returned ${resp.status}, using local fallback.`;
      }
    } catch (err) {
      clearTimeout(timeout);
      if (err.name === 'AbortError') {
        resultEl.innerHTML = 'Server request timed out (6s). Using local fallback.';
      } else {
        resultEl.innerHTML = 'Could not reach quiz endpoint. Using local fallback.';
      }
      console.warn('quiz.php fetch failed or timed out:', err);
    }

    // fallback to embedded questions when server-side generation fails or times out
    selectedQuestions = allQuestions.slice();
    shuffle(selectedQuestions);
    selectedQuestions = selectedQuestions.slice(0, count);
    selectedQuestions.forEach(q => shuffle(q.choices));
    displayQuestions();
    // clear any lingering loading text
    setTimeout(() => { if (resultEl && resultEl.innerHTML.startsWith('Loading')) resultEl.innerHTML = ''; }, 300);
    window.location.hash = '#quiz';
  }

  /*
    Displays the selected questions on the page
  */
  function displayQuestions(){
    const container = document.getElementById('quizContainer');
    container.innerHTML = '';

    selectedQuestions.forEach((q, i) => {
      const box = document.createElement('div');
      box.className = 'feature-card';

      let html = `<h3 dir="ltr">${i+1}. ${q.question}</h3>`;

      // If the question has choices, render radios; otherwise render an open-answer textarea
      if (Array.isArray(q.choices) && q.choices.length > 0) {
        q.choices.forEach(choice => {
          html += `
          <label style="display:block;margin:.25rem 0">
            <input type="radio" name="q${i}" value="${choice}"> ${choice}
          </label>`;
        });
      } else {
        // open / fill-in-the-blank input
        html += `
          <div style="margin-top:.5rem">
            <textarea name="q${i}_open" placeholder="Write your answer here..." 
              style="width:100%;min-height:88px;padding:.5rem;border:1px solid #e0e0e0;border-radius:6px;font-size:1rem;font-family:inherit;resize:vertical"></textarea>
          </div>`;
      }

      box.innerHTML = html;
      container.appendChild(box);
    });

    // Add "Check Answers" button
    const checkBtn = document.createElement('a');
    checkBtn.className = 'btn btn-primary';
    checkBtn.textContent = 'Check Answers';
    checkBtn.href = '#result';
    checkBtn.style.display = 'inline-block';
    checkBtn.style.marginTop = '1rem';

    // Prevent default link behavior and check answers instead
    checkBtn.addEventListener('click', (e) => { 
      e.preventDefault(); 
      checkAnswers(); 
    });

    container.appendChild(checkBtn);
  }

  /*
    Checks the user's answers:
    - Counts correct responses
    - Calculates percentage
    - Colors the score based on performance
  */
  function checkAnswers(){
    let score = 0;

    for(let i=0;i<selectedQuestions.length;i++){
      const q = selectedQuestions[i];
      if (Array.isArray(q.choices) && q.choices.length > 0) {
        const sel = document.querySelector(`input[name="q${i}"]:checked`);
        if(sel && sel.value === q.answer) score++;
      } else {
        // open answer grading: compare trimmed, case-insensitive if answer exists
        const ta = document.querySelector(`textarea[name="q${i}_open"]`);
        if (ta) {
          const user = (ta.value || '').trim();
          const corr = (q.answer || '').trim();
          if (corr !== '') {
            if (user !== '' && user.toLowerCase() === corr.toLowerCase()) score++;
          }
          // if no correct answer provided, we cannot auto-grade; leave as incorrect
        }
      }
    }

    const total = selectedQuestions.length || 1;
    const percent = Math.round((score/total)*100);

    // Choose color based on percentage
    let color = '#1e88e5'; // default blue
    if(percent >= 80) color = 'green';
    else if(percent >= 50) color = 'orange';
    else color = 'red';

    document.getElementById('result').innerHTML =
      `Your score: <span style="color:${color}">${score} / ${total} (${percent}%)</span>`;
  }

  /*
    Activates the Start button on page load
  */
  document.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('startBtn');
    if(startBtn) startBtn.addEventListener('click', (e) => { 
      e.preventDefault(); 
      startQuiz(); 
    });
  });
  </script>

 </body>
</html>
